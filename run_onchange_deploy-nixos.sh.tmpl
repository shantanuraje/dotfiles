#!/bin/bash
# NixOS System Configuration Deployment Script
# This script runs whenever NixOS configurations change
#
# File checksums to trigger on changes:
{{- range (glob "system_nixos/*") }}
# {{ . }}: {{ include . | sha256sum }}
{{- end }}

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log() {
    echo -e "${BLUE}[NIXOS-DEPLOY]${NC} $1"
}

success() {
    echo -e "${GREEN}[NIXOS-DEPLOY]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[NIXOS-DEPLOY]${NC} $1"
}

error() {
    echo -e "${RED}[NIXOS-DEPLOY]${NC} $1"
}

# Check if we're on NixOS
if [[ ! -f /etc/nixos/configuration.nix ]]; then
    warning "Not running on NixOS, skipping system deployment"
    exit 0
fi

log "Starting NixOS system configuration deployment..."

# Create backup of current /etc/nixos
BACKUP_DIR="/tmp/nixos-backup-$(date +%Y%m%d-%H%M%S)"
log "Creating backup at $BACKUP_DIR"
sudo mkdir -p "$BACKUP_DIR"
sudo cp -r /etc/nixos/* "$BACKUP_DIR/" 2>/dev/null || true

# Copy new configurations to /etc/nixos
log "Deploying new configuration files to /etc/nixos..."
SOURCE_DIR="{{ .chezmoi.sourceDir }}/system_nixos"

if [[ ! -d "$SOURCE_DIR" ]]; then
    error "Source directory $SOURCE_DIR not found!"
    exit 1
fi

# Copy each file individually with proper permissions
for file in "$SOURCE_DIR"/*; do
    if [[ -f "$file" ]]; then
        filename=$(basename "$file")
        log "Copying $filename..."
        sudo cp "$file" "/etc/nixos/$filename"
        sudo chown root:root "/etc/nixos/$filename"
        sudo chmod 644 "/etc/nixos/$filename"
    fi
done

# Validate the new configuration
log "Validating NixOS configuration..."
if ! sudo nixos-rebuild dry-build 2>/dev/null; then
    error "Configuration validation failed! Restoring backup..."
    sudo cp "$BACKUP_DIR"/* /etc/nixos/
    error "Backup restored. Please check your configuration files."
    exit 1
fi

# Apply the new configuration
log "Rebuilding NixOS system..."
if sudo nixos-rebuild switch; then
    success "NixOS system successfully rebuilt!"
    success "Backup saved at: $BACKUP_DIR"
    
    # Optional: Clean up old backups (keep last 5)
    find /tmp -name "nixos-backup-*" -type d | sort | head -n -5 | xargs -r sudo rm -rf
    
else
    error "NixOS rebuild failed! Restoring backup..."
    sudo cp "$BACKUP_DIR"/* /etc/nixos/
    error "Backup restored. Check the error messages above."
    exit 1
fi

success "NixOS deployment completed successfully!"